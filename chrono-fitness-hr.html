<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <meta name="theme-color" content="#000000" />
  <meta name="description" content="ChronomÃ¨tre fitness avec monitoring cardiaque Bluetooth en temps rÃ©el" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" type="image/png" sizes="192x192" href="./icon-192.png" />
  <link rel="apple-touch-icon" href="./icon-192.png" />
  <title>Chrono RC</title>
  <style>
    @font-face {
      font-family: 'Sto Fixed';
      src: url('./Sto-Fixed.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
      font-display: swap;
    }
    
    @font-face {
      font-family: 'Sto';
      src: url('./sto.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
      font-display: swap;
    }
    
    html,body{height:100%;margin:0;background:#000;color:#fff;font-family:'Sto',system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial,Helvetica,monospace}
    body{display:flex;align-items:center;justify-content:center;position:relative}
    
    /* Bouton menu hamburger en haut Ã  droite */
    #menuBtn{
      position:fixed;
      top:12px;
      right:12px;
      width:40px;
      height:40px;
      border:1px solid rgba(255,255,255,0.3);
      border-radius:8px;
      background:transparent;
      color:#fff;
      font-size:24px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:100;
      opacity:0.4;
      transition:all 0.3s;
    }
    #menuBtn:active{background:rgba(255,255,255,0.2);opacity:1}
    
    /* Cache le menu en mode paysage */
    @media (orientation: landscape){
      #menuBtn{display:none}
      #settingsPanel{display:none !important}
    }
    
    /* Panneau de paramÃ¨tres */
    #settingsPanel{
      position:fixed;
      top:0;
      right:-100%;
      width:min(400px, 90vw);
      height:100%;
      background:#1a1a1a;
      color:#fff;
      z-index:99;
      transition:right 0.3s ease;
      overflow-y:auto;
      padding:20px;
      box-shadow:-4px 0 12px rgba(0,0,0,0.5);
    }
    #settingsPanel.open{right:0}
    
    #settingsPanel h2{
      margin:0 0 20px 0;
      font-size:20px;
      font-weight:600;
    }
    #settingsPanel h3{
      margin:24px 0 12px 0;
      font-size:16px;
      font-weight:600;
      opacity:0.8;
    }
    
    .setting-group{
      margin-bottom:20px;
    }
    
    .setting-row{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:12px;
    }
    
    .setting-label{
      min-width:80px;
      font-size:14px;
      opacity:0.8;
    }
    
    input[type="number"]{
      background:#2a2a2a;
      border:1px solid rgba(255,255,255,0.2);
      color:#fff;
      padding:8px;
      border-radius:4px;
      width:70px;
      font-size:14px;
    }
    
    input[type="color"]{
      width:50px;
      height:35px;
      border:1px solid rgba(255,255,255,0.2);
      border-radius:4px;
      cursor:pointer;
      background:transparent;
    }
    
    .zone-config{
      background:#252525;
      padding:12px;
      border-radius:6px;
      margin-bottom:12px;
    }
    
    .zone-name{
      font-weight:600;
      margin-bottom:8px;
      font-size:14px;
    }
    
    #btConnectBtn{
      width:100%;
      padding:12px;
      background:#0a84ff;
      border:none;
      border-radius:6px;
      color:#fff;
      font-size:16px;
      font-weight:600;
      cursor:pointer;
      margin-top:8px;
    }
    #btConnectBtn:active{background:#0066cc}
    #btConnectBtn.connected{background:#34c759}
    #btConnectBtn.connecting{opacity:0.6}
    
    .close-overlay{
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background:rgba(0,0,0,0.5);
      z-index:98;
      display:none;
    }
    .close-overlay.visible{display:block}
    @keyframes pulse{
      0%,100%{opacity:1}
      50%{opacity:0.4}
    }
    
    #screen{
      width:100%;
      height:100%;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      touch-action:none;
      -webkit-user-select:none;
      user-select:none;
      gap:clamp(12px,3vh,32px)
    }
    
    /* Chrono (secondaire, en haut) */
    .time{
      font-family: 'Sto Fixed', monospace;
      font-weight:700;
      font-variant-numeric:tabular-nums;
      text-align:center;
      line-height:1;
      cursor:pointer;
      opacity:0.7;
    }
    .time{font-size:clamp(40px,10vh,100px)}
    @media (orientation: landscape){
      .time{font-size:clamp(56px,14vh,140px)}
    }
    
    /* FrÃ©quence cardiaque (principale) */
    .hr{
      font-family: 'Sto Fixed', monospace;
      font-weight:700;
      font-variant-numeric:tabular-nums;
      text-align:center;
      line-height:1;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:clamp(12px,2vh,24px);
      position:relative;
    }
    
    /* DÃ©gradÃ© pulsant en arriÃ¨re-plan */
    .hr::before{
      content:'';
      position:absolute;
      width:150%;
      height:150%;
      background:radial-gradient(circle, rgba(255,40,40,0.25) 0%, rgba(255,40,40,0.08) 40%, transparent 70%);
      border-radius:50%;
      z-index:-1;
      animation: pulseGlow var(--pulse-duration, 1s) ease-in-out infinite;
      transition:all 0.3s ease;
    }
    
    @keyframes pulseGlow{
      0%, 100%{
        transform:scale(0.95);
        opacity:0.6;
      }
      50%{
        transform:scale(1.1);
        opacity:1;
      }
    }
    
    .hr{font-size:clamp(64px,20vh,220px)}
    @media (orientation: landscape){
      .hr{font-size:clamp(80px,32vh,360px)}
    }
    .hr.inactive{opacity:0.3}
    .hr.inactive::before{
      animation:none;
      opacity:0;
    }
    
    *{-webkit-tap-highlight-color: transparent}
  </style>
</head>
<body>
  <button id="menuBtn" title="ParamÃ¨tres">â˜°</button>
  
  <div class="close-overlay" id="closeOverlay"></div>
  
  <div id="settingsPanel">
    <h2>ParamÃ¨tres</h2>
    
    <div class="setting-group">
      <h3>ðŸ”µ Bluetooth</h3>
      <button id="btConnectBtn">Connecter montre</button>
    </div>
    
    <div class="setting-group">
      <h3>ðŸ“Š Zones de frÃ©quence cardiaque</h3>
      
      <div class="zone-config">
        <div class="zone-name" style="color:#ffffff">âšª Repos</div>
        <div class="setting-row">
          <span class="setting-label">Max:</span>
          <input type="number" id="zone0Max" value="85" min="0" max="200">
          <span>bpm</span>
        </div>
        <div class="setting-row">
          <span class="setting-label">Couleur:</span>
          <input type="color" id="zone0Color" value="#ffffff">
        </div>
      </div>
      
      <div class="zone-config">
        <div class="zone-name" style="color:#6496ff">ðŸ”µ Ã‰chauffement</div>
        <div class="setting-row">
          <span class="setting-label">Max:</span>
          <input type="number" id="zone1Max" value="101" min="0" max="200">
          <span>bpm</span>
        </div>
        <div class="setting-row">
          <span class="setting-label">Couleur:</span>
          <input type="color" id="zone1Color" value="#6496ff">
        </div>
      </div>
      
      <div class="zone-config">
        <div class="zone-name" style="color:#64ff96">ðŸŸ¢ BrÃ»lage graisses</div>
        <div class="setting-row">
          <span class="setting-label">Max:</span>
          <input type="number" id="zone2Max" value="118" min="0" max="200">
          <span>bpm</span>
        </div>
        <div class="setting-row">
          <span class="setting-label">Couleur:</span>
          <input type="color" id="zone2Color" value="#64ff96">
        </div>
      </div>
      
      <div class="zone-config">
        <div class="zone-name" style="color:#ffff64">ðŸŸ¡ AÃ©robie</div>
        <div class="setting-row">
          <span class="setting-label">Max:</span>
          <input type="number" id="zone3Max" value="134" min="0" max="200">
          <span>bpm</span>
        </div>
        <div class="setting-row">
          <span class="setting-label">Couleur:</span>
          <input type="color" id="zone3Color" value="#ffff64">
        </div>
      </div>
      
      <div class="zone-config">
        <div class="zone-name" style="color:#ff9632">ðŸŸ  AnaÃ©robie</div>
        <div class="setting-row">
          <span class="setting-label">Max:</span>
          <input type="number" id="zone4Max" value="152" min="0" max="200">
          <span>bpm</span>
        </div>
        <div class="setting-row">
          <span class="setting-label">Couleur:</span>
          <input type="color" id="zone4Color" value="#ff9632">
        </div>
      </div>
      
      <div class="zone-config">
        <div class="zone-name" style="color:#ff5050">ðŸ”´ ExtrÃªme</div>
        <div class="setting-row">
          <span class="setting-label">Max:</span>
          <input type="number" id="zone5Max" value="170" min="0" max="200">
          <span>bpm</span>
        </div>
        <div class="setting-row">
          <span class="setting-label">Couleur:</span>
          <input type="color" id="zone5Color" value="#ff5050">
        </div>
      </div>
      
      <div class="zone-config">
        <div class="zone-name" style="color:#ff0000">ðŸ”´ Danger</div>
        <div class="setting-row">
          <span class="setting-label">Couleur:</span>
          <input type="color" id="zone6Color" value="#ff0000">
        </div>
      </div>
    </div>
  </div>
  
  <div id="screen" aria-hidden="false">
    <div id="time" class="time">00:00</div>
    <div id="hr" class="hr inactive"><span id="hrValue">---</span></div>
  </div>

  <script>
    const timeEl = document.getElementById('time');
    const hrEl = document.getElementById('hr');
    const hrValueEl = document.getElementById('hrValue');
    const menuBtn = document.getElementById('menuBtn');
    const settingsPanel = document.getElementById('settingsPanel');
    const closeOverlay = document.getElementById('closeOverlay');
    const btConnectBtn = document.getElementById('btConnectBtn');

    // ===== PARAMÃˆTRES =====
    let zones = [];
    
    function loadSettings(){
      const saved = localStorage.getItem('hrZones');
      if(saved){
        try{
          zones = JSON.parse(saved);
        }catch(e){
          zones = getDefaultZones();
        }
      }else{
        zones = getDefaultZones();
      }
      
      // Charger les valeurs dans les inputs
      zones.forEach((zone, i) => {
        const maxInput = document.getElementById(`zone${i}Max`);
        const colorInput = document.getElementById(`zone${i}Color`);
        if(maxInput) maxInput.value = zone.max;
        if(colorInput) colorInput.value = rgbToHex(zone.color);
      });
    }
    
    function getDefaultZones(){
      return [
        {max: 85, color: [255, 255, 255]},   // Blanc (repos)
        {max: 101, color: [100, 150, 255]},  // Bleu (Ã©chauffement)
        {max: 118, color: [100, 255, 150]},  // Vert (brÃ»lage graisses)
        {max: 134, color: [255, 255, 100]},  // Jaune (aÃ©robie)
        {max: 152, color: [255, 150, 50]},   // Orange (anaÃ©robie)
        {max: 170, color: [255, 80, 80]},    // Rouge (extrÃªme)
        {max: 999, color: [255, 0, 0]}       // Rouge pur (danger)
      ];
    }
    
    function saveSettings(){
      localStorage.setItem('hrZones', JSON.stringify(zones));
    }
    
    function updateZonesFromInputs(){
      zones.forEach((zone, i) => {
        const maxInput = document.getElementById(`zone${i}Max`);
        const colorInput = document.getElementById(`zone${i}Color`);
        if(maxInput) zone.max = parseInt(maxInput.value) || zone.max;
        if(colorInput) zone.color = hexToRgb(colorInput.value);
      });
      saveSettings();
    }
    
    function hexToRgb(hex){
      const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
      return result ? [
        parseInt(result[1], 16),
        parseInt(result[2], 16),
        parseInt(result[3], 16)
      ] : [255, 255, 255];
    }
    
    function rgbToHex(rgb){
      return '#' + rgb.map(x => {
        const hex = x.toString(16);
        return hex.length === 1 ? '0' + hex : hex;
      }).join('');
    }
    
    // Ã‰couter les changements dans les inputs
    for(let i = 0; i < 7; i++){
      const maxInput = document.getElementById(`zone${i}Max`);
      const colorInput = document.getElementById(`zone${i}Color`);
      if(maxInput) maxInput.addEventListener('change', updateZonesFromInputs);
      if(colorInput) colorInput.addEventListener('change', updateZonesFromInputs);
    }
    
    // Gestion du menu
    function toggleSettings(){
      const isOpen = settingsPanel.classList.contains('open');
      if(isOpen){
        settingsPanel.classList.remove('open');
        closeOverlay.classList.remove('visible');
      }else{
        settingsPanel.classList.add('open');
        closeOverlay.classList.add('visible');
      }
    }
    
    menuBtn.addEventListener('click', toggleSettings);
    closeOverlay.addEventListener('click', toggleSettings);

    // ===== CHRONO =====
    let startTs = performance.now();
    let lastSec = -1;

    function formatMS(ms){
      const totalSec = Math.floor(ms/1000);
      const secs = totalSec % 60;
      const mins = Math.floor(totalSec/60) % 100;
      return `${String(mins).padStart(2,'0')}:${String(secs).padStart(2,'0')}`;
    }

    function update(){
      const now = performance.now();
      const elapsed = now - startTs;
      const sec = Math.floor(elapsed/1000);
      if(sec !== lastSec){
        lastSec = sec;
        timeEl.textContent = formatMS(elapsed);
      }
      requestAnimationFrame(update);
    }
    requestAnimationFrame(update);

    function reset(){
      startTs = performance.now();
      lastSec = -1;
      tryEnterFullscreenIfLandscape();
    }

    function tryEnterFullscreenIfLandscape(){
      try{
        if(window.matchMedia && window.matchMedia('(orientation: landscape)').matches){
          const el = document.documentElement;
          if(document.fullscreenElement == null && el.requestFullscreen){
            el.requestFullscreen().catch(()=>{});
          }
        }
      }catch(e){}
    }

    function onPointer(ev){
      reset();
      ev.preventDefault();
    }

    timeEl.addEventListener('touchstart', onPointer, {passive:false});
    timeEl.addEventListener('mousedown', onPointer);
    hrEl.addEventListener('touchstart', onPointer, {passive:false});
    hrEl.addEventListener('mousedown', onPointer);

    if(window.matchMedia){
      const mq = window.matchMedia('(orientation: landscape)');
      mq.addEventListener('change', ()=>{
        tryEnterFullscreenIfLandscape();
      });
    }

    window.addEventListener('contextmenu', e=>e.preventDefault());
    window.addEventListener('keydown', (e)=>{ 
      if(e.key.toLowerCase()==='r'){ reset(); }
      if(e.key.toLowerCase()==='m'){ toggleSettings(); }
    });

    // ===== BLUETOOTH HEART RATE =====
    let btDevice = null;
    let btServer = null;
    let hrCharacteristic = null;

    // Interpolation de couleur progressive
    function getHRColor(bpm){
      // Trouver les deux zones encadrantes
      let lowerZone = zones[0];
      let upperZone = zones[1];
      
      for(let i = 0; i < zones.length - 1; i++){
        if(bpm <= zones[i].max){
          lowerZone = i > 0 ? zones[i-1] : zones[i];
          upperZone = zones[i];
          break;
        }
        if(i === zones.length - 2){
          lowerZone = zones[i];
          upperZone = zones[i+1];
        }
      }
      
      // Calculer le ratio d'interpolation
      const lowerMax = lowerZone.max;
      const upperMax = upperZone.max;
      const ratio = Math.max(0, Math.min(1, (bpm - lowerMax) / (upperMax - lowerMax)));
      
      // Interpoler RGB
      const r = Math.round(lowerZone.color[0] + (upperZone.color[0] - lowerZone.color[0]) * ratio);
      const g = Math.round(lowerZone.color[1] + (upperZone.color[1] - lowerZone.color[1]) * ratio);
      const b = Math.round(lowerZone.color[2] + (upperZone.color[2] - lowerZone.color[2]) * ratio);
      
      return `rgb(${r}, ${g}, ${b})`;
    }

    function updateHR(bpm){
      hrEl.classList.remove('inactive');
      hrValueEl.textContent = bpm;
      hrEl.style.color = getHRColor(bpm);
      
      // Calculer la durÃ©e de l'animation en fonction du BPM
      // bpm battements par minute = bpm/60 battements par seconde
      // donc 1 battement prend 60/bpm secondes
      const animationDuration = 60 / bpm;
      hrEl.style.setProperty('--pulse-duration', `${animationDuration}s`);
    }

    function clearHR(){
      hrEl.classList.add('inactive');
      hrValueEl.textContent = '---';
      hrEl.style.color = '#fff';
      hrEl.style.setProperty('--pulse-duration', '1s');
    }

    async function connectBluetooth(){
      if(btDevice && btDevice.gatt.connected){
        // DÃ©jÃ  connectÃ©, on dÃ©connecte
        disconnectBluetooth();
        return;
      }

      try{
        btConnectBtn.classList.add('connecting');
        btConnectBtn.textContent = 'Connexion...';
        
        // Recherche d'appareils avec Heart Rate Service
        btDevice = await navigator.bluetooth.requestDevice({
          filters: [{services: ['heart_rate']}],
          optionalServices: ['heart_rate']
        });

        // Gestion de la dÃ©connexion inattendue
        btDevice.addEventListener('gattserverdisconnected', onDisconnected);

        // Connexion au serveur GATT
        btServer = await btDevice.gatt.connect();
        
        // RÃ©cupÃ©ration du service Heart Rate
        const service = await btServer.getPrimaryService('heart_rate');
        
        // RÃ©cupÃ©ration de la caractÃ©ristique Heart Rate Measurement
        hrCharacteristic = await service.getCharacteristic('heart_rate_measurement');
        
        // Activation des notifications
        await hrCharacteristic.startNotifications();
        
        // Ã‰coute des changements de valeur
        hrCharacteristic.addEventListener('characteristicvaluechanged', handleHRChange);
        
        btConnectBtn.classList.remove('connecting');
        btConnectBtn.classList.add('connected');
        btConnectBtn.textContent = 'DÃ©connecter';
        
        // Fermer le menu automatiquement aprÃ¨s connexion rÃ©ussie
        toggleSettings();
        
      }catch(error){
        console.error('Erreur Bluetooth:', error);
        btConnectBtn.classList.remove('connecting', 'connected');
        btConnectBtn.textContent = 'Connecter montre';
        clearHR();
        
        // Message d'erreur discret
        if(error.name === 'NotFoundError'){
          console.log('Aucun appareil sÃ©lectionnÃ©');
        }else{
          alert('Erreur de connexion Bluetooth');
        }
      }
    }

    function disconnectBluetooth(){
      if(hrCharacteristic){
        hrCharacteristic.removeEventListener('characteristicvaluechanged', handleHRChange);
        hrCharacteristic = null;
      }
      if(btDevice && btDevice.gatt.connected){
        btDevice.gatt.disconnect();
      }
      btDevice = null;
      btServer = null;
      
      btConnectBtn.classList.remove('connecting', 'connected');
      btConnectBtn.textContent = 'Connecter montre';
      clearHR();
    }

    function onDisconnected(){
      console.log('Montre dÃ©connectÃ©e');
      disconnectBluetooth();
    }

    function handleHRChange(event){
      const value = event.target.value;
      // Le premier octet contient des flags
      const flags = value.getUint8(0);
      // Si le bit 0 est Ã  0, la FC est sur 8 bits (offset 1)
      // Si le bit 0 est Ã  1, la FC est sur 16 bits (offset 1-2)
      let hr;
      if(flags & 0x01){
        hr = value.getUint16(1, true); // little endian
      }else{
        hr = value.getUint8(1);
      }
      updateHR(hr);
    }

    btConnectBtn.addEventListener('click', connectBluetooth);
    
    // VÃ©rifier si l'API Bluetooth est disponible
    if(!navigator.bluetooth){
      btConnectBtn.style.display = 'none';
      console.warn('Web Bluetooth API non disponible');
    }
    
    // Charger les paramÃ¨tres au dÃ©marrage
    loadSettings();
    
    // ===== ENREGISTREMENT SERVICE WORKER (PWA) =====
    if('serviceWorker' in navigator){
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(registration => {
            console.log('Service Worker enregistrÃ©:', registration.scope);
          })
          .catch(error => {
            console.log('Erreur Service Worker:', error);
          });
      });
    }
  </script>
</body>
</html>
